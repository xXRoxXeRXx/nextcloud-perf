<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nextcloud Performance Tool</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .container {
            max-width: 1000px;
        }

        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            font-size: 0.85em;
        }

        .progress-stages {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .stage {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            margin: 0 5px;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .stage.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .stage.done {
            background: #2ecc71;
            color: white;
        }

        .stage i {
            font-size: 1.5em;
            display: block;
            margin-bottom: 5px;
        }

        .current-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-status .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            height: 25px;
            border-radius: 12px;
            background: #e0e0e0;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .fail-dot {
            color: #ff4757;
        }

        .quality-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 5px;
            vertical-align: middle;
        }

        .quality-green {
            background-color: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
        }

        .quality-yellow {
            background-color: #f1c40f;
            box-shadow: 0 0 8px #f1c40f;
        }

        .quality-red {
            background-color: #e74c3c;
            box-shadow: 0 0 8px #e74c3c;
        }

        .quality-none {
            background-color: #bdc3c7;
        }

        .conclusion-text {
            margin-top: 10px;
            font-size: 0.8em;
            font-weight: bold;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .text-green {
            color: #27ae60;
        }

        .text-yellow {
            color: #d68910;
        }

        .text-red {
            color: #c0392b;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-cloud"></i> Nextcloud Performance Check</h1>
            <div class="subtitle">System & Network Analysis Tool</div>
        </header>

        <!-- Login Card -->
        <div class="card" id="loginCard">
            <h2><i class="fas fa-sign-in-alt"></i> Connection Details</h2>
            <div class="form-group">
                <label for="url">Nextcloud URL</label>
                <input type="text" id="url" placeholder="https://cloud.example.com" value="https://">
            </div>
            <div class="form-group">
                <label for="user">Username</label>
                <input type="text" id="user" placeholder="Your Username">
            </div>
            <div class="form-group">
                <label for="pass">Password / App Token</label>
                <input type="password" id="pass" placeholder="Your Password"
                    onkeypress="if(event.key==='Enter')startTest()">
            </div>
            <button class="btn-primary" onclick="startTest()">
                <i class="fas fa-tachometer-alt"></i> Start Benchmark
            </button>
        </div>

        <!-- Testing UI -->
        <div class="card" id="progressCard" style="display: none;">
            <h2><i class="fas fa-running"></i> Test in Progress</h2>

            <!-- Stage Indicators -->
            <div class="progress-stages">
                <div class="stage" id="stage-system"><i class="fas fa-desktop"></i> System</div>
                <div class="stage" id="stage-network"><i class="fas fa-network-wired"></i> Network</div>
                <div class="stage" id="stage-connect"><i class="fas fa-plug"></i> Connect</div>
                <div class="stage" id="stage-benchmark"><i class="fas fa-tachometer-alt"></i> Benchmark</div>
                <div class="stage" id="stage-report"><i class="fas fa-file-alt"></i> Report</div>
            </div>

            <!-- Current Status -->
            <div class="current-status">
                <div class="spinner"></div>
                <span id="currentStatus">Initializing...</span>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
            </div>

            <!-- Log Output -->
            <div class="log-output" id="log"></div>
        </div>

        <!-- Results Card -->
        <div class="card" id="resultsCard" style="display: none;">
            <div
                style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                <i class="fas fa-check-circle" style="font-size: 50px; margin-bottom: 15px;"></i>
                <h2 style="margin: 0;">Benchmark Completed!</h2>
            </div>

            <h3 style="margin-bottom: 15px;"><i class="fas fa-globe"></i> Reference Speed (Speedtest.net)</h3>
            <div class="card"
                style="background: #f0f4ff; border-color: #d1dbff; text-align: center; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <div class="metric-label" style="font-weight: bold;">Internet Service Provider</div>
                        <div class="metric-value" style="font-size: 1.1em;" id="resProvider">--</div>
                    </div>
                    <div>
                        <div class="metric-label" style="font-weight: bold;">Benchmark Server</div>
                        <div class="metric-value" style="font-size: 1.1em;" id="resStServer">--</div>
                    </div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                <div
                    style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bbf7d0;">
                    <div style="font-size: 0.85em; color: #166534;">Upload (Ref)</div>
                    <div style="font-size: 1.4em; font-weight: bold; color: #166534;" id="refUp">--</div>
                </div>
                <div
                    style="background: #fff5f5; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ffcccc;">
                    <div style="font-size: 0.85em; color: #cc0000;">Download (Ref)</div>
                    <div style="font-size: 1.4em; font-weight: bold; color: #cc0000;" id="refDown">--</div>
                </div>
            </div>

            <h3 style="margin-bottom: 15px;"><i class="fas fa-tachometer-alt"></i> Transfer Speed Results</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Small Files</div>
                    <div style="font-size: 0.7em; opacity: 0.7;">5 x 512KB</div>
                    <div style="margin-top: 10px;">
                        <span style="font-size: 0.8em; opacity: 0.8;">Upload:</span>
                        <span style="font-size: 1.2em; font-weight: bold;" id="resSmall">--</span>
                        <span class="quality-indicator quality-none" id="qSmallUp"></span>
                    </div>
                    <div style="margin-top: 5px;">
                        <span style="font-size: 0.8em; opacity: 0.8;">Download:</span>
                        <span style="font-size: 1.2em; font-weight: bold;" id="resSmallDown">--</span>
                        <span class="quality-indicator quality-none" id="qSmallDown"></span>
                    </div>
                    <div class="conclusion-text" id="concSmall"></div>
                </div>
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Medium Files</div>
                    <div style="font-size: 0.7em; opacity: 0.7;">3 x 5MB</div>
                    <div style="margin-top: 10px;">
                        <span style="font-size: 0.8em; opacity: 0.8;">Upload:</span>
                        <span style="font-size: 1.2em; font-weight: bold;" id="resMedium">--</span>
                        <span class="quality-indicator quality-none" id="qMedUp"></span>
                    </div>
                    <div style="margin-top: 5px;">
                        <span style="font-size: 0.8em; opacity: 0.8;">Download:</span>
                        <span style="font-size: 1.2em; font-weight: bold;" id="resMediumDown">--</span>
                        <span class="quality-indicator quality-none" id="qMedDown"></span>
                    </div>
                    <div class="conclusion-text" id="concMed"></div>
                </div>
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Large File</div>
                    <div style="font-size: 0.7em; opacity: 0.7;">256MB (25MB Chunks)</div>
                    <div style="margin-top: 10px;">
                        <span style="font-size: 0.8em; opacity: 0.8;">Upload:</span>
                        <span style="font-size: 1.2em; font-weight: bold;" id="resLarge">--</span>
                        <span class="quality-indicator quality-none" id="qLargeUp"></span>
                    </div>
                    <div style="margin-top: 5px;">
                        <span style="font-size: 0.8em; opacity: 0.8;">Download:</span>
                        <span style="font-size: 1.2em; font-weight: bold;" id="resLargeDown">--</span>
                        <span class="quality-indicator quality-none" id="qLargeDown"></span>
                    </div>
                    <div class="conclusion-text" id="concLarge"></div>
                </div>
            </div>

            <h3 style="margin-bottom: 15px;"><i class="fas fa-network-wired"></i> Network Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                <div class="card">
                    <div style="font-size: 0.85em; opacity: 0.8;">Avg Latency</div>
                    <div class="metric-value">
                        <span id="resPing">--</span>
                        <span class="quality-indicator quality-none" id="qPing"></span>
                    </div>
                </div>
                <div class="card">
                    <div style="font-size: 0.85em; opacity: 0.8;">Packet Loss</div>
                    <div class="metric-value">
                        <span id="resPacketLoss">--</span>
                        <span class="quality-indicator quality-none" id="qLoss"></span>
                    </div>
                </div>
                <div class="card">
                    <div style="font-size: 0.85em; opacity: 0.8;">DNS Resolution</div>
                    <div class="metric-value">
                        <span id="resDNS">--</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <a href="/report/download" target="_blank" class="btn-primary"
                    style="display: inline-block; text-decoration: none; padding: 18px 50px; font-size: 1.1em;">
                    <i class="fas fa-file-download"></i> Download Detailed Report
                </a>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn-secondary" onclick="location.reload()" style="padding: 12px 30px;">
                    <i class="fas fa-redo"></i> Run New Test
                </button>
            </div>
        </div>
    </div>

    <script>
        const evtSource = new EventSource("/events");
        const logDiv = document.getElementById("log");
        const progressBar = document.getElementById("progressBar");
        const currentStatus = document.getElementById("currentStatus");

        let currentStage = '';

        function setStage(stage) {
            if (currentStage === stage) return;

            // Mark previous as done
            if (currentStage) {
                document.getElementById('stage-' + currentStage).classList.remove('active');
                document.getElementById('stage-' + currentStage).classList.add('done');
            }

            currentStage = stage;
            document.getElementById('stage-' + stage).classList.add('active');
        }

        function setProgress(percent) {
            progressBar.style.width = percent + "%";
            progressBar.innerText = percent + "%";
        }

        evtSource.addEventListener("message", function (event) {
            const msg = event.data;

            // Add to log
            logDiv.innerHTML += "<div>" + msg + "</div>";
            logDiv.scrollTop = logDiv.scrollHeight;

            // Update current status display
            currentStatus.innerText = msg;

            // Determine stage and progress based on message content
            if (msg.includes("System") || msg.includes("Collecting System")) {
                setStage('system');
                setProgress(10);
            }
            if (msg.includes("DNS") || msg.includes("Ping") || msg.includes("Traceroute")) {
                setStage('network');
                if (msg.includes("DNS")) setProgress(20);
                if (msg.includes("Ping")) setProgress(30);
                if (msg.includes("Traceroute")) setProgress(40);
            }
            if (msg.includes("Connecting") || msg.includes("Connected")) {
                setStage('connect');
                setProgress(45);
            }
            // Speedtest Logic
            if (msg.includes("Reference Speedtest") || msg.includes("Ref Speed")) {
                setStage('network'); // Reuse network stage or add new one? keeping simple
                if (msg.includes("Running")) setProgress(12);
                if (msg.includes("Speedtest:")) setProgress(15);
                if (msg.includes("Ref Speed")) setProgress(18);
            }
            if (msg.includes("Small Files") || msg.includes("Medium Files") || msg.includes("Large File") || msg.includes("chunk")) {
                setStage('benchmark');
                // Uploads: 50 -> 70%
                // Downloads: 70 -> 90%

                if (msg.includes("Starting Small Files Test")) setProgress(52);
                if (msg.includes("Small Files Upload")) setProgress(55);

                if (msg.includes("Starting Small Files Download")) setProgress(57);
                if (msg.includes("Small Files Download")) setProgress(60);

                if (msg.includes("Starting Medium Files Test")) setProgress(62);
                if (msg.includes("Medium Files Upload")) setProgress(65);

                if (msg.includes("Starting Medium Files Download")) setProgress(67);
                if (msg.includes("Medium Files Download")) setProgress(70);

                if (msg.includes("Starting Large File Test")) setProgress(72);
                if (msg.includes("chunk")) {
                    const match = msg.match(/chunk (\d+)/);
                    if (match) {
                        const chunkNum = parseInt(match[1]);
                        // Chunk 1-52 mapping to 72-82%
                        setProgress(72 + Math.min(Math.floor(chunkNum * 0.2), 10));
                    }
                }
                if (msg.includes("Large File Upload")) setProgress(82);

                if (msg.includes("Starting Large File Download")) setProgress(85);
                if (msg.includes("Large File Download")) setProgress(90);
            }
            if (msg.includes("Cleanup") || msg.includes("Generating Report") || msg.includes("Report Ready")) {
                setStage('report');
                if (msg.includes("Cleanup")) setProgress(92);
                if (msg.includes("Generating")) setProgress(95);
                if (msg.includes("Ready")) setProgress(98);
            }
        });

        evtSource.addEventListener("result", function (event) {
            let data;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
                logDiv.innerHTML += "<div style='color:red'>JSON Parse Error: " + e + "</div>";
                console.error("JSON Parse Error", e, event.data);
                return;
            }

            setProgress(100);

            function updateQualityDot(id, speed, limit, isLarge) {
                const dot = document.getElementById(id);
                if (!speed || speed <= 0 || !limit || limit <= 0) {
                    dot.className = 'quality-indicator quality-none';
                    return;
                }
                const ratio = speed / limit;
                let quality = 'red';
                if (isLarge) {
                    if (ratio > 0.85) quality = 'green';
                    else if (ratio > 0.55) quality = 'yellow';
                } else {
                    if (ratio > 0.50) quality = 'green';
                    else if (ratio > 0.30) quality = 'yellow';
                }
                dot.className = `quality-indicator quality-${quality}`;
                return quality;
            }

            function getConclusion(quality) {
                switch (quality) {
                    case 'green': return '<span class="text-green">Exzellente Verbindung</span>';
                    case 'yellow': return '<span class="text-yellow">Solide Leistung</span>';
                    case 'red': return '<span class="text-red">Optimierungsbedarf</span>';
                    default: return '';
                }
            }

            function updateConclusion(id, q1, q2) {
                const el = document.getElementById(id);
                // Worst-case performance wins the conclusion
                let finalQ = 'green';
                if (q1 === 'red' || q2 === 'red') finalQ = 'red';
                else if (q1 === 'yellow' || q2 === 'yellow') finalQ = 'yellow';
                else if (q1 === 'none' || q2 === 'none') finalQ = '';

                el.innerHTML = getConclusion(finalQ);
            }
            // Only show results if completed or error
            if (data.error) {
                document.getElementById('progressCard').style.display = 'none';
                document.getElementById('resultsCard').style.display = 'block';

                // Update header to red failure state
                const header = document.querySelector('#resultsCard > div:first-child');
                header.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                header.innerHTML = '<i class="fas fa-exclamation-circle" style="font-size: 50px; margin-bottom: 15px;"></i><h2 style="margin: 0;">Benchmark Failed</h2><div style="margin-top:10px; font-size: 1.1em; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 5px;">' + data.error + '</div>';

            } else if (data.Completed) {
                document.getElementById('progressCard').style.display = 'none';
                document.getElementById('resultsCard').style.display = 'block';

                // Reset header to green success state (in case of retry)
                const header = document.querySelector('#resultsCard > div:first-child');
                header.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                header.innerHTML = '<i class="fas fa-check-circle" style="font-size: 50px; margin-bottom: 15px;"></i><h2 style="margin: 0;">Benchmark Completed!</h2>';
            }


            // Populate Speed Results (Upload)
            document.getElementById('resSmall').innerText = (data.SmallFiles.speed_mbps > 0) ? (data.SmallFiles.speed_mbps.toFixed(2) + " MB/s") : "--";
            document.getElementById('resMedium').innerText = (data.MediumFiles.speed_mbps > 0) ? (data.MediumFiles.speed_mbps.toFixed(2) + " MB/s") : "--";
            document.getElementById('resLarge').innerText = (data.LargeFile.speed_mbps > 0) ? (data.LargeFile.speed_mbps.toFixed(2) + " MB/s") : "--";

            // Populate Speed Results (Download)
            document.getElementById('resSmallDown').innerText = (data.SmallFilesDown.speed_mbps > 0) ? (data.SmallFilesDown.speed_mbps.toFixed(2) + " MB/s") : "--";
            document.getElementById('resMediumDown').innerText = (data.MediumFilesDown.speed_mbps > 0) ? (data.MediumFilesDown.speed_mbps.toFixed(2) + " MB/s") : "--";
            document.getElementById('resLargeDown').innerText = (data.LargeFileDown.speed_mbps > 0) ? (data.LargeFileDown.speed_mbps.toFixed(2) + " MB/s") : "--";

            // Network Summary
            if (data.PingStats) {
                document.getElementById('resPing').innerText = data.PingStats.avg_ms.toFixed(2) + ' ms';
                document.getElementById('resPacketLoss').innerText = data.PingStats.packet_loss.toFixed(1) + '%';

                let pingQ = 'green';
                if (data.PingStats.avg_ms > 60) pingQ = 'red';
                else if (data.PingStats.avg_ms > 25) pingQ = 'yellow';
                document.getElementById('qPing').className = `quality-indicator quality-${pingQ}`;

                let lossQ = 'green';
                if (data.PingStats.packet_loss > 1) lossQ = 'red';
                else if (data.PingStats.packet_loss > 0) lossQ = 'yellow';
                document.getElementById('qLoss').className = `quality-indicator quality-${lossQ}`;
            }
            if (data.DNS) {
                if (data.DNS.resolution_time > 0) {
                    document.getElementById('resDNS').innerText = data.DNS.resolution_time.toFixed(1) + " ms";
                }
            }

            // Reference Speed
            if (data.Speedtest) {
                if (data.Speedtest.error) {
                    document.getElementById('refDown').innerText = "Error";
                    document.getElementById('refUp').innerText = "Error";
                    document.getElementById('refDown').style.color = "#cc0000";
                    document.getElementById('refUp').style.color = "#cc0000";
                } else {
                    const uMbps = data.Speedtest.upload_speed || 0;
                    const dMbps = data.Speedtest.download_speed || 0;
                    const uMBps = data.Speedtest.upload_mbps || 0;
                    const dMBps = data.Speedtest.download_mbps || 0;

                    document.getElementById('refUp').innerText = `${uMBps.toFixed(2)} MB/s (${uMbps.toFixed(2)} Mbps)`;
                    document.getElementById('refDown').innerText = `${dMBps.toFixed(2)} MB/s (${dMbps.toFixed(2)} Mbps)`;

                    // Evaluate Quality
                    const limitUp = Math.min(uMBps, 10);
                    const limitDown = Math.min(dMBps, 50);

                    const qSUp = updateQualityDot('qSmallUp', data.SmallFiles.speed_mbps, limitUp, false);
                    const qSDown = updateQualityDot('qSmallDown', data.SmallFilesDown.speed_mbps, limitDown, false);
                    updateConclusion('concSmall', qSUp, qSDown);

                    const qMUp = updateQualityDot('qMedUp', data.MediumFiles.speed_mbps, limitUp, false);
                    const qMDown = updateQualityDot('qMedDown', data.MediumFilesDown.speed_mbps, limitDown, false);
                    updateConclusion('concMed', qMUp, qMDown);

                    const qLUp = updateQualityDot('qLargeUp', data.LargeFile.speed_mbps, limitUp, true);
                    const qLDown = updateQualityDot('qLargeDown', data.LargeFileDown.speed_mbps, limitDown, true);
                    updateConclusion('concLarge', qLUp, qLDown);

                    // ISP & Server Info
                    if (data.Speedtest.isp) {
                        document.getElementById('resProvider').innerText = data.Speedtest.isp;
                    }
                    if (data.Speedtest.server_name) {
                        document.getElementById('resStServer').innerText = data.Speedtest.server_name;
                    }
                }
            }
        });

        async function startTest() {
            const url = document.getElementById('url').value;
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;

            if (!url || !user || !pass) {
                alert("Please fill in all fields.");
                return;
            }

            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('progressCard').style.display = 'block';

            try {
                await fetch('/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, user, pass })
                });
            } catch (e) {
                alert("Error: " + e);
                location.reload();
            }
        }
    </script>
</body>

</html>